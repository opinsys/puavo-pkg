#!/bin/sh

set -eu

command=$1
shift

case "${command}" in
    configure)
        upstream_dir=$1

        mkdir -p /opt/spotify
        ln -s -f -T "${upstream_dir}/opt/spotify/spotify-client" /opt/spotify/spotify-client

        mkdir -p /usr/bin
        ln -s -f -T "${upstream_dir}/opt/spotify/spotify-client/spotify" /usr/bin/spotify

        mkdir -p /usr/share/icons/hicolor/16x16/apps
        mkdir -p /usr/share/icons/hicolor/22x22/apps
        mkdir -p /usr/share/icons/hicolor/24x24/apps
        mkdir -p /usr/share/icons/hicolor/32x32/apps
        mkdir -p /usr/share/icons/hicolor/48x48/apps
        mkdir -p /usr/share/icons/hicolor/64x64/apps
        mkdir -p /usr/share/icons/hicolor/128x128/apps
        mkdir -p /usr/share/icons/hicolor/256x256/apps

        ln -s -f -T "${upstream_dir}/opt/spotify/spotify-client/Icons/spotify-linux-16.png" \
            /usr/share/icons/hicolor/16x16/apps/spotify-client.png
        ln -s -f -T "${upstream_dir}/opt/spotify/spotify-client/Icons/spotify-linux-22.png" \
            /usr/share/icons/hicolor/22x22/apps/spotify-client.png
        ln -s -f -T "${upstream_dir}/opt/spotify/spotify-client/Icons/spotify-linux-24.png" \
            /usr/share/icons/hicolor/24x24/apps/spotify-client.png
        ln -s -f -T "${upstream_dir}/opt/spotify/spotify-client/Icons/spotify-linux-32.png" \
            /usr/share/icons/hicolor/32x32/apps/spotify-client.png
        ln -s -f -T "${upstream_dir}/opt/spotify/spotify-client/Icons/spotify-linux-48.png" \
            /usr/share/icons/hicolor/48x48/apps/spotify-client.png
        ln -s -f -T "${upstream_dir}/opt/spotify/spotify-client/Icons/spotify-linux-64.png" \
            /usr/share/icons/hicolor/64x64/apps/spotify-client.png
        ln -s -f -T "${upstream_dir}/opt/spotify/spotify-client/Icons/spotify-linux-128.png" \
            /usr/share/icons/hicolor/128x128/apps/spotify-client.png
        ln -s -f -T "${upstream_dir}/opt/spotify/spotify-client/Icons/spotify-linux-256.png" \
            /usr/share/icons/hicolor/256x256/apps/spotify-client.png

        mkdir -p /usr/share/applications
        ln -s -f -T "${upstream_dir}/opt/spotify/spotify-client/spotify.desktop" \
            /usr/share/applications/spotify.desktop
        ;;

    unconfigure)

        rm -f /usr/bin/spotify \
            /opt/spotify/spotify-client \
            /usr/share/applications/spotify.desktop \
            /usr/share/icons/hicolor/16x16/apps/spotify-client.png \
            /usr/share/icons/hicolor/22x22/apps/spotify-client.png \
            /usr/share/icons/hicolor/24x24/apps/spotify-client.png \
            /usr/share/icons/hicolor/32x32/apps/spotify-client.png \
            /usr/share/icons/hicolor/48x48/apps/spotify-client.png \
            /usr/share/icons/hicolor/64x64/apps/spotify-client.png \
            /usr/share/icons/hicolor/128x128/apps/spotify-client.png \
            /usr/share/icons/hicolor/256x256/apps/spotify-client.png

        ;;

    unpack)
        upstream_pack=$1
        upstream_dir=$2
        dpkg -x "${upstream_pack}" "${upstream_dir}"
        chmod 0755 "${upstream_dir}"
        ;;

    download)
        upstream_pack=$1
        baseurl="http://repository-origin.spotify.com"
        tmpfile=$(mktemp)
        wget \
            --no-use-server-timestamps \
            --no-check-certificate \
            --no-cookies \
            --output-document "${tmpfile}" \
            "${baseurl}/dists/stable/non-free/binary-amd64/Packages" || {
            rm -f "${tmpfile}"
            exit 1
        }
        poolpath=$(sed -r '0,/^Package: spotify-client$/ d' "${tmpfile}" | sed -r -n 's/^Filename: (.*)/\1/p' | head -n1)
        rm -f "${tmpfile}"
        wget \
            --no-use-server-timestamps \
            --no-check-certificate \
            --no-cookies \
            --output-document "${upstream_pack}" \
            "${baseurl}/${poolpath}"
        ;;

    *)
        ;;
esac
